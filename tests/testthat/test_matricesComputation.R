library(RandomWalkRestartMH)

############################################################
context("Matrices Computation")
############################################################

## Multiplex
m1 <- igraph::make_graph(c(1,2,1,3,2,3), directed = FALSE)
m2 <- igraph::make_graph(c(1,3,2,3,3,4,1,4), directed = FALSE)

m3 <- igraph::make_graph(c(1,2,1,4,1,6,2,3,2,4,3,5,3,6,4,6,5,6), directed = FALSE)
m4 <- igraph::make_graph(c(1,2,1,4,1,5,2,4,2,5), directed = FALSE)
m5 <- igraph::make_graph(c(2,3,2,5,2,6,3,4,3,5,4,6,5,6), directed = FALSE)
m6 <- igraph::make_graph(c(1,3,1,5,1,6,2,4,2,5,3,4,3,5,4,6), directed = FALSE)

m7 <- igraph::make_graph(c(1,2,2,3,3,1,3,2), directed = TRUE)
m8 <- igraph::make_graph(c(1,3,1,4,2,1,2,3,4,1,4,3), directed = TRUE)

h1 <- igraph::make_graph(c("A","C","B","E","E","D","E","C"), directed = FALSE)
h2 <- igraph::make_graph(c("A","B","A","C","A","E","B","D","C","E"), directed = FALSE)

bipartite_relations <- data.frame(m=c(1,3),h=c("A","E"))
bipartite_relations2 <- data.frame(m=c(1,1,2,3),h=c("A","D","C","E"))

describe("compute.transition.matrix.homogeneous", {
  it("creates the correct transition matrix with 2 layers and default delta", {
    multiObject_1 <- create.multiplex(list(m1=m1,m2=m2))
    TranMatrix1 <- compute.transition.matrix.homogeneous(multiObject_1)

    TranMatrixExpected1 <- matrix(c(0,0.25,0.25,0,0.5,0,0,0,
                                    0.25,0,0.25,0,0,0.5,0,0,
                                    0.25,0.25,0,0,0,0,0.5,0,
                                    0,0,0,0,0,0,0,0.5,
                                    0.5,0,0,0,0,0,0.166666667,0.25,
                                    0,0.5,0,0,0,0,0.166666667,0,
                                    0,0,0.5,0,0.25,0.5,0,0.25,
                                    0,0,0,1,0.25,0,0.166666667,0),
                                  byrow = TRUE, nrow = 8, ncol = 8)
    colnames(TranMatrixExpected1) <- c("1_1","2_1","3_1","4_1","1_2","2_2",
                                       "3_2","4_2")
    rownames(TranMatrixExpected1) <- c("1_1","2_1","3_1","4_1","1_2","2_2",
                                       "3_2","4_2")
    TranMatrixExpected1 <- as(TranMatrixExpected1, "dgCMatrix")

    expect_equal(TranMatrix1, TranMatrixExpected1, tolerance = 0.00001)
  })

  it("creates the correct transition matrix with 4 layers using non-default delta", {
    multiObject_2 <- create.multiplex(list(m1=m3,m2=m4,m3=m5,m4=m6))
    TranMatrix2 <- compute.transition.matrix.homogeneous(multiObject_2, delta=0.35)

    TranMatrixExpected2 <- matrix(c(0.0000000,0.2166667,0.0000000,0.2166667,0.0000000,0.1625000,0.1166667,0.0000000,0.0000000,0.0000000,0.0000000,0.0000000,0.3333333,0.0000000,0.0000000,0.0000000,0.0000000,0.0000000,0.1166667,0.0000000,0.0000000,0.0000000,0.0000000,0.0000000,
                                    0.2166667,0.0000000,0.2166667,0.2166667,0.0000000,0.0000000,0.0000000,0.1166667,0.0000000,0.0000000,0.0000000,0.0000000,0.0000000,0.1166667,0.0000000,0.0000000,0.0000000,0.0000000,0.0000000,0.1166667,0.0000000,0.0000000,0.0000000,0.0000000,
                                    0.0000000,0.2166667,0.0000000,0.0000000,0.3250000,0.1625000,0.0000000,0.0000000,0.3333333,0.0000000,0.0000000,0.0000000,0.0000000,0.0000000,0.1166667,0.0000000,0.0000000,0.0000000,0.0000000,0.0000000,0.1166667,0.0000000,0.0000000,0.0000000,
                                    0.2166667,0.2166667,0.0000000,0.0000000,0.0000000,0.1625000,0.0000000,0.0000000,0.0000000,0.1166667,0.0000000,0.0000000,0.0000000,0.0000000,0.0000000,0.1166667,0.0000000,0.0000000,0.0000000,0.0000000,0.0000000,0.1166667,0.0000000,0.0000000,
                                    0.0000000,0.0000000,0.2166667,0.0000000,0.0000000,0.1625000,0.0000000,0.0000000,0.0000000,0.0000000,0.1166667,0.0000000,0.0000000,0.0000000,0.0000000,0.0000000,0.1166667,0.0000000,0.0000000,0.0000000,0.0000000,0.0000000,0.1166667,0.0000000,
                                    0.2166667,0.0000000,0.2166667,0.2166667,0.3250000,0.0000000,0.0000000,0.0000000,0.0000000,0.0000000,0.0000000,0.3333333,0.0000000,0.0000000,0.0000000,0.0000000,0.0000000,0.1166667,0.0000000,0.0000000,0.0000000,0.0000000,0.0000000,0.1166667,
                                    0.1166667,0.0000000,0.0000000,0.0000000,0.0000000,0.0000000,0.0000000,0.2166667,0.0000000,0.3250000,0.3250000,0.0000000,0.3333333,0.0000000,0.0000000,0.0000000,0.0000000,0.0000000,0.1166667,0.0000000,0.0000000,0.0000000,0.0000000,0.0000000,
                                    0.0000000,0.1166667,0.0000000,0.0000000,0.0000000,0.0000000,0.2166667,0.0000000,0.0000000,0.3250000,0.3250000,0.0000000,0.0000000,0.1166667,0.0000000,0.0000000,0.0000000,0.0000000,0.0000000,0.1166667,0.0000000,0.0000000,0.0000000,0.0000000,
                                    0.0000000,0.0000000,0.1166667,0.0000000,0.0000000,0.0000000,0.0000000,0.0000000,0.0000000,0.0000000,0.0000000,0.0000000,0.0000000,0.0000000,0.1166667,0.0000000,0.0000000,0.0000000,0.0000000,0.0000000,0.1166667,0.0000000,0.0000000,0.0000000,
                                    0.0000000,0.0000000,0.0000000,0.1166667,0.0000000,0.0000000,0.2166667,0.2166667,0.0000000,0.0000000,0.0000000,0.0000000,0.0000000,0.0000000,0.0000000,0.1166667,0.0000000,0.0000000,0.0000000,0.0000000,0.0000000,0.1166667,0.0000000,0.0000000,
                                    0.0000000,0.0000000,0.0000000,0.0000000,0.1166667,0.0000000,0.2166667,0.2166667,0.0000000,0.0000000,0.0000000,0.0000000,0.0000000,0.0000000,0.0000000,0.0000000,0.1166667,0.0000000,0.0000000,0.0000000,0.0000000,0.0000000,0.1166667,0.0000000,
                                    0.0000000,0.0000000,0.0000000,0.0000000,0.0000000,0.1166667,0.0000000,0.0000000,0.0000000,0.0000000,0.0000000,0.0000000,0.0000000,0.0000000,0.0000000,0.0000000,0.0000000,0.1166667,0.0000000,0.0000000,0.0000000,0.0000000,0.0000000,0.1166667,
                                    0.1166667,0.0000000,0.0000000,0.0000000,0.0000000,0.0000000,0.1166667,0.0000000,0.0000000,0.0000000,0.0000000,0.0000000,0.0000000,0.0000000,0.0000000,0.0000000,0.0000000,0.0000000,0.1166667,0.0000000,0.0000000,0.0000000,0.0000000,0.0000000,
                                    0.0000000,0.1166667,0.0000000,0.0000000,0.0000000,0.0000000,0.0000000,0.1166667,0.0000000,0.0000000,0.0000000,0.0000000,0.0000000,0.0000000,0.2166667,0.0000000,0.2166667,0.2166667,0.0000000,0.1166667,0.0000000,0.0000000,0.0000000,0.0000000,
                                    0.0000000,0.0000000,0.1166667,0.0000000,0.0000000,0.0000000,0.0000000,0.0000000,0.3333333,0.0000000,0.0000000,0.0000000,0.0000000,0.2166667,0.0000000,0.3250000,0.2166667,0.0000000,0.0000000,0.0000000,0.1166667,0.0000000,0.0000000,0.0000000,
                                    0.0000000,0.0000000,0.0000000,0.1166667,0.0000000,0.0000000,0.0000000,0.0000000,0.0000000,0.1166667,0.0000000,0.0000000,0.0000000,0.0000000,0.2166667,0.0000000,0.0000000,0.2166667,0.0000000,0.0000000,0.0000000,0.1166667,0.0000000,0.0000000,
                                    0.0000000,0.0000000,0.0000000,0.0000000,0.1166667,0.0000000,0.0000000,0.0000000,0.0000000,0.0000000,0.1166667,0.0000000,0.0000000,0.2166667,0.2166667,0.0000000,0.0000000,0.2166667,0.0000000,0.0000000,0.0000000,0.0000000,0.1166667,0.0000000,
                                    0.0000000,0.0000000,0.0000000,0.0000000,0.0000000,0.1166667,0.0000000,0.0000000,0.0000000,0.0000000,0.0000000,0.3333333,0.0000000,0.2166667,0.0000000,0.3250000,0.2166667,0.0000000,0.0000000,0.0000000,0.0000000,0.0000000,0.0000000,0.1166667,
                                    0.1166667,0.0000000,0.0000000,0.0000000,0.0000000,0.0000000,0.1166667,0.0000000,0.0000000,0.0000000,0.0000000,0.0000000,0.3333333,0.0000000,0.0000000,0.0000000,0.0000000,0.0000000,0.0000000,0.0000000,0.2166667,0.0000000,0.2166667,0.3250000,
                                    0.0000000,0.1166667,0.0000000,0.0000000,0.0000000,0.0000000,0.0000000,0.1166667,0.0000000,0.0000000,0.0000000,0.0000000,0.0000000,0.1166667,0.0000000,0.0000000,0.0000000,0.0000000,0.0000000,0.0000000,0.0000000,0.2166667,0.2166667,0.0000000,
                                    0.0000000,0.0000000,0.1166667,0.0000000,0.0000000,0.0000000,0.0000000,0.0000000,0.3333333,0.0000000,0.0000000,0.0000000,0.0000000,0.0000000,0.1166667,0.0000000,0.0000000,0.0000000,0.2166667,0.0000000,0.0000000,0.2166667,0.2166667,0.0000000,
                                    0.0000000,0.0000000,0.0000000,0.1166667,0.0000000,0.0000000,0.0000000,0.0000000,0.0000000,0.1166667,0.0000000,0.0000000,0.0000000,0.0000000,0.0000000,0.1166667,0.0000000,0.0000000,0.0000000,0.3250000,0.2166667,0.0000000,0.0000000,0.3250000,
                                    0.0000000,0.0000000,0.0000000,0.0000000,0.1166667,0.0000000,0.0000000,0.0000000,0.0000000,0.0000000,0.1166667,0.0000000,0.0000000,0.0000000,0.0000000,0.0000000,0.1166667,0.0000000,0.2166667,0.3250000,0.2166667,0.0000000,0.0000000,0.0000000,
                                    0.0000000,0.0000000,0.0000000,0.0000000,0.0000000,0.1166667,0.0000000,0.0000000,0.0000000,0.0000000,0.0000000,0.3333333,0.0000000,0.0000000,0.0000000,0.0000000,0.0000000,0.1166667,0.2166667,0.0000000,0.0000000,0.2166667,0.0000000,0.0000000),
				                          byrow = TRUE, nrow = 24, ncol = 24)

    colnames(TranMatrixExpected2) <- c("1_1","2_1","3_1","4_1","5_1","6_1",
                                       "1_2","2_2","3_2","4_2","5_2","6_2",
                                       "1_3","2_3","3_3","4_3","5_3","6_3",
                                       "1_4","2_4","3_4","4_4","5_4","6_4")
    rownames(TranMatrixExpected2) <- c("1_1","2_1","3_1","4_1","5_1","6_1",
                                       "1_2","2_2","3_2","4_2","5_2","6_2",
                                       "1_3","2_3","3_3","4_3","5_3","6_3",
                                      "1_4","2_4","3_4","4_4","5_4","6_4")

    TranMatrixExpected2 <- as(TranMatrixExpected2, "dgCMatrix")

    expect_equal(TranMatrix2, TranMatrixExpected2, tolerance = 0.00001)
  })

  # TODO: Need to update simplify.layers to handle directed graphs
  # it("creates the correct transition matrix with 2 layers using directed graphs", {
  #   multiObject3 <- create.multiplex(list(m1=m7,m2=m8))
  #   TranMatrix3 <- compute.transition.matrix.homogeneous(multiObject3, delta=0.46)

  #   TranMatrixExpected3 <- matrix(c(0.00,0.00,0.27,0.00,0.46,0.00,0.00,0.00,
  #                                   0.54,0.00,0.27,0.00,0.00,0.46,0.00,0.00,
  #                                   0.00,0.54,0.00,0.00,0.00,0.00,1.00,0.00,
  #                                   0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.46,
  #                                   0.46,0.00,0.00,0.00,0.00,0.27,0.00,0.27,
  #                                   0.00,0.46,0.00,0.00,0.00,0.00,0.00,0.00,
  #                                   0.00,0.00,0.46,0.00,0.27,0.27,0.00,0.27,
  #                                   0.00,0.00,0.00,1.00,0.27,0.00,0.00,0.00),
	# 			                          byrow = TRUE, nrow = 8, ncol = 8)

  #   colnames(TranMatrixExpected3) <- c("1_1","2_1","3_1","4_1","1_2","2_2","3_2","4_2")
  #   rownames(TranMatrixExpected3) <- c("1_1","2_1","3_1","4_1","1_2","2_2","3_2","4_2")

  #   TranMatrixExpected3 <- as(TranMatrixExpected3, "dgCMatrix")

  #   expect_equal(TranMatrix3, TranMatrixExpected3, tolerance = 0.00001)
  # })
})

describe("compute.transition.matrix.heterogeneous", {
  it("creates the correct transition matrix with 2 layers in group 1, 1 layer in group 2, and default delta & lamda", {
    multiObject_4 <- create.multiplex(list(m1=m1,m2=m2))
    multiObject_5 <- create.multiplex(list(h1=h1))

    multiHetObject1 <- create.multiplexHet(multiObject_4, multiObject_5, bipartite_relations)
    MultiHetTranMatrix1 <- compute.transition.matrix.heterogeneous(multiHetObject1)

    MultiHetTranMatrixExpected1 <- matrix(c(0.0000000,0.2500000,0.1250000,0.0000000,0.2500000,0.0000000,0.0000000,0.0000000,0.2500000,0.0000000,0.0000000,0.0000000,0.0000000,
                                            0.1250000,0.0000000,0.1250000,0.0000000,0.0000000,0.5000000,0.0000000,0.0000000,0.0000000,0.0000000,0.0000000,0.0000000,0.0000000,
                                            0.1250000,0.2500000,0.0000000,0.0000000,0.0000000,0.0000000,0.2500000,0.0000000,0.0000000,0.0000000,0.0000000,0.0000000,0.2500000,
                                            0.0000000,0.0000000,0.0000000,0.0000000,0.0000000,0.0000000,0.0000000,0.5000000,0.0000000,0.0000000,0.0000000,0.0000000,0.0000000,
                                            0.2500000,0.0000000,0.0000000,0.0000000,0.0000000,0.0000000,0.0833333,0.2500000,0.2500000,0.0000000,0.0000000,0.0000000,0.0000000,
                                            0.0000000,0.5000000,0.0000000,0.0000000,0.0000000,0.0000000,0.0833333,0.0000000,0.0000000,0.0000000,0.0000000,0.0000000,0.0000000,
                                            0.0000000,0.0000000,0.2500000,0.0000000,0.1250000,0.5000000,0.0000000,0.2500000,0.0000000,0.0000000,0.0000000,0.0000000,0.2500000,
                                            0.0000000,0.0000000,0.0000000,1.0000000,0.1250000,0.0000000,0.0833333,0.0000000,0.0000000,0.0000000,0.0000000,0.0000000,0.0000000,
                                            0.5000000,0.0000000,0.0000000,0.0000000,0.5000000,0.0000000,0.0000000,0.0000000,0.0000000,0.0000000,0.5000000,0.0000000,0.0000000,
                                            0.0000000,0.0000000,0.0000000,0.0000000,0.0000000,0.0000000,0.0000000,0.0000000,0.0000000,0.0000000,0.0000000,0.0000000,0.1666667,
                                            0.0000000,0.0000000,0.0000000,0.0000000,0.0000000,0.0000000,0.0000000,0.0000000,0.5000000,0.0000000,0.0000000,0.0000000,0.1666667,
                                            0.0000000,0.0000000,0.0000000,0.0000000,0.0000000,0.0000000,0.0000000,0.0000000,0.0000000,0.0000000,0.0000000,0.0000000,0.1666667,
                                            0.0000000,0.0000000,0.5000000,0.0000000,0.0000000,0.0000000,0.5000000,0.0000000,0.0000000,1.0000000,0.5000000,1.0000000,0.0000000),
                                          byrow = TRUE, nrow = 13, ncol = 13)
    colnames(MultiHetTranMatrixExpected1) <- c("1_1","2_1","3_1","4_1","1_2","2_2",
                                              "3_2","4_2","A_1","B_1","C_1","D_1","E_1")
    rownames(MultiHetTranMatrixExpected1) <- c("1_1","2_1","3_1","4_1","1_2","2_2",
                                              "3_2","4_2","A_1","B_1","C_1","D_1","E_1")
    MultiHetTranMatrixExpected1 <- as(MultiHetTranMatrixExpected1, "dgCMatrix")
    
    expect_equal(MultiHetTranMatrix1, MultiHetTranMatrixExpected1, tolerance = 0.00001)
  })

  it("creates the correct transition matrix with 2 layers in group 1, 2 layer in group 2, and non-default deltas & lamda", {
    multiObject_6 <- create.multiplex(list(m1=m1, m2=m2))
    multiObject_7 <- create.multiplex(list(h1=h1, h2=h2))
    
    multiHetObject2 <- create.multiplexHet(multiObject_6, multiObject_7, bipartite_relations2)
    MultiHetTranMatrix2 <- compute.transition.matrix.heterogeneous(multiHetObject2, delta1 = 0.45, delta2 = 0.47, lambda = 0.6)

    MultiHetTranMatrixExpected2 <- matrix(c(0.000000,0.110000,0.110000,0.000000,0.180000,0.000000,0.000000,0.000000,0.300000,0.000000,0.000000,0.300000,0.000000,0.300000,0.000000,0.000000,0.300000,0.000000,
                                            0.110000,0.000000,0.110000,0.000000,0.000000,0.180000,0.000000,0.000000,0.000000,0.000000,0.300000,0.000000,0.000000,0.000000,0.000000,0.300000,0.000000,0.000000,
                                            0.110000,0.110000,0.000000,0.000000,0.000000,0.000000,0.180000,0.000000,0.000000,0.000000,0.000000,0.000000,0.300000,0.000000,0.000000,0.000000,0.000000,0.300000,
                                            0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.450000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,
                                            0.180000,0.000000,0.000000,0.000000,0.000000,0.000000,0.073333,0.275000,0.300000,0.000000,0.000000,0.300000,0.000000,0.300000,0.000000,0.000000,0.300000,0.000000,
                                            0.000000,0.180000,0.000000,0.000000,0.000000,0.000000,0.073333,0.000000,0.000000,0.000000,0.300000,0.000000,0.000000,0.000000,0.000000,0.300000,0.000000,0.000000,
                                            0.000000,0.000000,0.180000,0.000000,0.110000,0.220000,0.000000,0.275000,0.000000,0.000000,0.000000,0.000000,0.300000,0.000000,0.000000,0.000000,0.000000,0.300000,
                                            0.000000,0.000000,0.000000,1.000000,0.110000,0.000000,0.073333,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,
                                            0.150000,0.000000,0.000000,0.000000,0.150000,0.000000,0.000000,0.000000,0.000000,0.000000,0.106000,0.000000,0.000000,0.188000,0.000000,0.000000,0.000000,0.000000,
                                            0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.070667,0.000000,0.470000,0.000000,0.000000,0.000000,
                                            0.000000,0.300000,0.000000,0.000000,0.000000,0.300000,0.000000,0.000000,0.212000,0.000000,0.000000,0.000000,0.070667,0.000000,0.000000,0.188000,0.000000,0.000000,
                                            0.150000,0.000000,0.000000,0.000000,0.150000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.070667,0.000000,0.000000,0.000000,0.188000,0.000000,
                                            0.000000,0.000000,0.300000,0.000000,0.000000,0.000000,0.300000,0.000000,0.000000,0.530000,0.106000,0.212000,0.000000,0.000000,0.000000,0.000000,0.000000,0.188000,
                                            0.150000,0.000000,0.000000,0.000000,0.150000,0.000000,0.000000,0.000000,0.188000,0.000000,0.000000,0.000000,0.000000,0.000000,0.265000,0.106000,0.000000,0.106000,
                                            0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.470000,0.000000,0.000000,0.000000,0.070667,0.000000,0.000000,0.212000,0.000000,
                                            0.000000,0.300000,0.000000,0.000000,0.000000,0.300000,0.000000,0.000000,0.000000,0.000000,0.188000,0.000000,0.000000,0.070667,0.000000,0.000000,0.000000,0.106000,
                                            0.150000,0.000000,0.000000,0.000000,0.150000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.188000,0.000000,0.000000,0.265000,0.000000,0.000000,0.000000,
                                            0.000000,0.000000,0.300000,0.000000,0.000000,0.000000,0.300000,0.000000,0.000000,0.000000,0.000000,0.000000,0.188000,0.070667,0.000000,0.106000,0.000000,0.000000),
                                          byrow = TRUE, nrow = 18, ncol = 18)
    colnames(MultiHetTranMatrixExpected2) <- c("1_1","2_1","3_1","4_1","1_2","2_2","3_2","4_2",
                                               "A_1","B_1","C_1","D_1","E_1","A_2","B_2","C_2","D_2","E_2")
    rownames(MultiHetTranMatrixExpected2) <- c("1_1","2_1","3_1","4_1","1_2","2_2","3_2","4_2",
                                               "A_1","B_1","C_1","D_1","E_1","A_2","B_2","C_2","D_2","E_2")
    MultiHetTranMatrixExpected2 <- as(MultiHetTranMatrixExpected2, "dgCMatrix")

    expect_equal(MultiHetTranMatrix2, MultiHetTranMatrixExpected2, tolerance = 0.00001)
  })
})
